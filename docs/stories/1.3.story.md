# Story 1.3: Payload CMS Integration

## Status

**Done** ✅ All tasks complete, DOD verified

## Story

**As an** administrator,  
**I want** to access a fully configured Payload CMS admin panel,  
**so that** I can manage website content (media, pages) separately from application data.

## Dependencies

- **Story 1.1** (Completed): Next.js project initialization with Payload CMS
- **Story 1.2** (Completed): Database and Prisma setup

## Acceptance Criteria

1. Payload CMS 3.x installed with PostgreSQL adapter
2. Payload configured in Next.js project
3. Admin panel accessible and functional at `/admin`
4. Payload Users collection extended and documented with clear separation from Prisma User (dual-ORM strategy)
5. Media collection configured for image uploads with required alt-text and optional caption
6. Admin user can log in and view dashboard
7. Payload API endpoints available (`/api/...`)
8. TypeScript types generated from Payload collections

## Tasks / Subtasks

- [x] **Task 1: Verify existing Payload setup** (AC: 1, 2, 3)
  - [x] Confirm Payload CMS 3.x is installed (`pnpm list payload`)
  - [x] Verify `@payloadcms/db-postgres` adapter is configured
  - [x] Verify admin panel is accessible at `/admin`
  - [x] Document Payload versions in Dev Notes

- [x] **Task 2: Extend Users collection with display fields and document dual-ORM** (AC: 4)
  - [x] Add `displayName` field to Users collection
  - [x] Add `role` field with admin/editor options for CMS access
  - [x] Document the separation between Payload Users (CMS admins) and Prisma User (app users) - see Dev Notes
  - [x] Regenerate TypeScript types after changes

- [x] **Task 3: Configure Media collection for image uploads** (AC: 5)
  - [x] Add required `alt` field for accessibility (WCAG compliance)
  - [x] Add optional `caption` field
  - [x] Configure `imageSizes` for thumbnail and full-size
  - [x] Set up `mimeTypes` for allowed file formats (image/*)
  - [x] Configure `adminThumbnail` for admin preview
  - [x] Test image upload via admin panel

- [x] **Task 4: Create admin user** (AC: 6)
  - [x] Run `pnpm dev` and navigate to `/admin`
  - [x] Create first admin user via setup-wizard
  - [x] Verify login works
  - [x] Test that dashboard shows Collections and globals

- [x] **Task 5: Verify Payload API endpoints** (AC: 7)
  - [x] Test `/api/users` returns collection data (requires auth)
  - [x] Test `/api/media` works for uploads
  - [x] Test GraphQL playground at `/api/graphql-playground` (development mode only - not available in production)
  - [x] Document API structure in Dev Notes

- [x] **Task 6: Regenerate and verify TypeScript types** (AC: 8)
  - [x] Run `pnpm payload generate:types` (or equivalent)
  - [x] Verify that `src/payload-types.ts` is updated
  - [x] Test that types are available in IDE (intellisense)
  - [x] Export relevant types from a central location if needed

- [x] **Task 7: Document dual-ORM strategy** (AC: 4)
  - [x] Update README or dev notes with dual-ORM explanation
  - [x] Document when to use Payload vs Prisma
  - [x] Add inline comments in configuration files (NFR1 - learning project)

- [x] **Task 8: Verify and test** (AC: all)
  - [x] Go through all AC and verify fulfillment
  - [x] Test that `pnpm dev` starts without errors
  - [x] Test that admin panel works with created user
  - [x] Test that media can be uploaded and displayed

## Dev Notes

### Previous Story Insights (fra Story 1.1 og 1.2)
[Source: docs/stories/1.1.story.md#Dev Agent Record, docs/stories/1.2.story.md#Dev Agent Record]

- **Prosjektet bruker `create-payload-app` som base** - Payload CMS er allerede installert og konfigurert
- Admin panel er allerede tilgjengelig på `/admin` (verifisert i Story 1.1)
- **Dual-ORM strategi:** Payload håndterer CMS-data via Drizzle internt, Prisma håndterer app-data
- Prisma er satt opp med User-modell og singleton pattern (Story 1.2)
- Deployment til Vercel fungerer: https://devhub-virid.vercel.app
- Prisma 7 bruker adapter pattern (`@prisma/adapter-pg`)

### Dual-ORM Strategi - KRITISK FORSTÅELSE
[Source: docs/architecture.md#Data Models]

DevHub bruker en **dual-ORM strategi** som er viktig å forstå:

```
┌─────────────────────────────────────────────────────────────────┐
│                    PostgreSQL Database                          │
├────────────────────────────┬────────────────────────────────────┤
│     PAYLOAD TABLES         │         PRISMA TABLES              │
│     (CMS-innhold)          │         (App-data)                 │
├────────────────────────────┼────────────────────────────────────┤
│  • users (CMS admin)       │  • User (App-brukere fra Clerk)    │
│  • media                   │  • Snippet (Story 2.1)             │
│  • pages (Story 1.6)       │  • Tag (Story 2.4)                 │
│  • payload_migrations      │  • Discussion (Story 3.1)          │
│  • _pages_blocks_*         │  • ... mer i senere stories        │
└────────────────────────────┴────────────────────────────────────┘
```

**VIKTIG:** 
- **Payload `users`** = CMS-administratorer som logger inn på `/admin`
- **Prisma `User`** = App-brukere som logger inn via Clerk (implementeres i Story 1.4)
- Disse er **separate tabeller** i samme database - de "synkroniseres" ikke runtime
- AC4 refererer til at feltene skal være **konsistente/dokumenterte**, ikke automatisk sync

### Eksisterende Payload-konfigurasjon
[Source: src/payload.config.ts]

Payload er allerede konfigurert med:
- `@payloadcms/db-postgres` adapter
- `lexicalEditor` for rich text
- `sharp` for bildebehandling
- Users og Media collections (grunnleggende versjon)
- TypeScript type output til `src/payload-types.ts`

```typescript
// Eksisterende struktur (src/payload.config.ts)
export default buildConfig({
  admin: {
    user: Users.slug,
    // ...
  },
  collections: [Users, Media],
  editor: lexicalEditor(),
  db: postgresAdapter({
    pool: { connectionString: process.env.DATABASE_URL || '' },
  }),
  // ...
});
```

### Users Collection - Utvidelse
[Source: docs/architecture.md#Data Models]

Utvid eksisterende Users collection med flere felter for bedre administrasjon:

```typescript
// src/collections/Users.ts - OPPDATERT
import type { CollectionConfig } from 'payload';

export const Users: CollectionConfig = {
  slug: 'users',
  admin: {
    useAsTitle: 'email',
    // Beskrivelse for læringsformål
    description: 'CMS-administratorer som har tilgang til admin panel. IKKE det samme som app-brukere (Prisma User).',
  },
  auth: true,
  fields: [
    // Email legges til automatisk av auth: true
    {
      name: 'displayName',
      type: 'text',
      label: 'Display Name',
      admin: {
        description: 'Valgfritt visningsnavn for admin-brukeren',
      },
    },
    {
      name: 'role',
      type: 'select',
      label: 'CMS Role',
      defaultValue: 'editor',
      options: [
        { label: 'Admin', value: 'admin' },
        { label: 'Editor', value: 'editor' },
      ],
      admin: {
        description: 'Admin har full tilgang, Editor kan bare redigere innhold',
      },
    },
  ],
  // Tilgangskontroll basert på rolle
  access: {
    // Alle autentiserte kan lese
    read: ({ req: { user } }) => Boolean(user),
    // Kun admins kan opprette nye brukere
    create: ({ req: { user } }) => user?.role === 'admin',
    // Brukere kan oppdatere seg selv, admins kan oppdatere alle
    update: ({ req: { user }, id }) => {
      if (user?.role === 'admin') return true;
      return user?.id === id;
    },
    // Kun admins kan slette
    delete: ({ req: { user } }) => user?.role === 'admin',
  },
};
```

### Media Collection - Fullstendig konfigurasjon
[Source: docs/architecture.md#Tech Stack - sharp, Payload Media]

```typescript
// src/collections/Media.ts - OPPDATERT
import type { CollectionConfig } from 'payload';

export const Media: CollectionConfig = {
  slug: 'media',
  admin: {
    description: 'Bildeopplastinger for CMS-innhold og pagebuilder',
  },
  access: {
    // Alle kan lese media (bilder er offentlige)
    read: () => true,
    // Kun autentiserte CMS-brukere kan laste opp
    create: ({ req: { user } }) => Boolean(user),
    update: ({ req: { user } }) => Boolean(user),
    delete: ({ req: { user } }) => user?.role === 'admin',
  },
  fields: [
    {
      name: 'alt',
      type: 'text',
      required: true,
      label: 'Alt Text',
      admin: {
        description: 'Beskrivende tekst for tilgjengelighet (WCAG)',
      },
    },
    {
      name: 'caption',
      type: 'text',
      label: 'Caption',
      admin: {
        description: 'Valgfri bildetekst',
      },
    },
  ],
  upload: {
    // Statiske filer lagres i media-mappe
    staticDir: 'media',
    // Tillatte MIME-typer
    mimeTypes: ['image/*'],
    // Bildeoptimalisering med sharp
    imageSizes: [
      {
        name: 'thumbnail',
        width: 400,
        height: 300,
        position: 'centre',
      },
      {
        name: 'card',
        width: 768,
        height: 576,
        position: 'centre',
      },
      {
        name: 'full',
        width: 1920,
        height: undefined, // Behold aspect ratio
      },
    ],
    // Admin thumbnail for preview
    adminThumbnail: 'thumbnail',
  },
};
```

### Payload API-endepunkter
[Source: docs/architecture.md#API Specification]

Payload genererer automatisk REST og GraphQL API:

| Endpoint | Metode | Beskrivelse |
|----------|--------|-------------|
| `/api/users` | GET/POST | CRUD for CMS-brukere (krever auth) |
| `/api/media` | GET/POST | CRUD for media/bilder |
| `/api/media/:id` | GET/PATCH/DELETE | Enkelt media-dokument |
| `/api/graphql` | POST | GraphQL API |
| `/api/graphql-playground` | GET | GraphQL IDE (kun development) |

**MERK:** Payload API er for CMS-data. App-data (snippets, etc.) bruker Server Actions med Prisma.

### Prosjektstruktur (etter denne story)
[Source: docs/architecture.md#Unified Project Structure]

```
devhub/
├── src/
│   ├── app/
│   │   └── (payload)/
│   │       ├── admin/           # Payload admin panel
│   │       └── api/             # Payload API routes
│   ├── collections/
│   │   ├── Users.ts             # ← OPPDATERT: Utvidet med role/displayName
│   │   └── Media.ts             # ← OPPDATERT: Fullstendig upload config
│   ├── payload.config.ts        # Payload hovedkonfigurasjon
│   └── payload-types.ts         # ← REGENERERT: TypeScript typer
├── media/                       # ← NY: Upload-mappe for media
└── prisma/
    └── schema.prisma            # App-data (separat fra Payload)
```

### TypeScript Type Generation
[Source: docs/architecture.md#Coding Standards]

Payload genererer typer automatisk. For å regenerere manuelt:

```bash
# Generer typer fra Payload collections
pnpm payload generate:types

# Eller via npm script (legg til i package.json hvis ikke finnes)
pnpm db:payload:types
```

Genererte typer brukes slik:
```typescript
import type { User, Media } from '@/payload-types';

// Type-safe tilgang til Payload-data
const user: User = await payload.findByID({
  collection: 'users',
  id: 'abc123',
});
```

### Environment Variables
[Source: docs/architecture.md#External APIs]

Disse er allerede konfigurert fra Story 1.1/1.2:

```bash
# .env.local (allerede satt opp)

# Payload CMS
PAYLOAD_SECRET=your-secret-here-min-32-chars  # Brukt for session encryption
NEXT_PUBLIC_SERVER_URL=http://localhost:3000   # For admin panel

# Database (Vercel Postgres) - delt med Prisma
DATABASE_URL=postgres://...
```

### Coding Standards Reminder
[Source: docs/architecture.md#Coding Standards, docs/prd.md#NFR1]

- **Kommenter "hvorfor"** - Forklar hvorfor collections er strukturert slik
- **Type everything** - Bruk Payload-genererte typer konsekvent
- **Dokumenter dual-ORM** - Tydeliggjør når man bruker Payload vs Prisma
- **Access control** - Alltid definer eksplisitte access-regler

## Testing

### Testlokasjon
[Source: docs/architecture.md#Testing Strategy]

```
tests/
├── setup.ts                  # Global setup
└── integration/
    └── payload/
        └── collections.test.ts  # ← VALGFRITT: Collection tests
```

### Testing for denne story

**Manuell verifisering (tilstrekkelig for Story 1.3):**

1. `pnpm dev` starter uten feil
2. Naviger til `http://localhost:3000/admin`
3. Opprett admin-bruker via setup-wizard (første gang)
4. Logg inn og verifiser dashboard vises
5. Naviger til Users collection - se at displayName og role felter finnes
6. Naviger til Media collection - last opp et testbilde
7. Verifiser at thumbnail og andre bildestørrelser genereres
8. Test `/api/media` returnerer media-dokumenter
9. Test `/api/graphql-playground` åpnes i browser (development)
10. Verifiser at `src/payload-types.ts` inneholder User og Media typer

**Valgfritt - Integrasjonstest:**
```typescript
// tests/integration/payload/collections.test.ts
import { describe, it, expect, beforeAll } from 'vitest';

describe('Payload Collections', () => {
  // Krever running Payload instance
  // Valgfritt for læringsprosjekt
  it.skip('Users collection has required fields', async () => {
    // Test med Payload Local API hvis nødvendig
  });
});
```

**MERK:** For Payload-testing, er manuell verifisering via admin panel ofte tilstrekkelig. Payload har sin egen testinfrastruktur for complex cases.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-21 | 0.1 | Initial story draft | SM Bob |
| 2026-01-22 | 1.0 | PO Review: Fixed AC4 (removed misleading "synchronized" terminology), added Dependencies section, clarified AC5 (alt-text requirement), updated task descriptions for clarity, translated key sections to English | PO Sarah |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (via Cursor)

### Debug Log References
- Node 18 mangler `File` API for Payload type generation - må bruke Node 20+
- Payload dev-modus pusher schema automatisk, migrations feilet pga eksisterende tabeller (slettet migration-filer)
- **KRITISK:** Payload prøvde å slette Prisma-tabeller ved schema push - løst med `schemaName: 'payload'` i postgres adapter
- PostgreSQL schema `payload` opprettet manuelt: `CREATE SCHEMA IF NOT EXISTS payload;`

### Completion Notes List
- Users collection utvidet med `displayName` (text) og `role` (select: admin/editor)
- Media collection utvidet med `caption` (text) og fullstendig upload-konfigurasjon
- Access control implementert for begge collections (rolle-basert RBAC)
- TypeScript typer generert med nye felter
- README oppdatert med dual-ORM arkitektur-dokumentasjon
- Payload CMS 3.72.0 verifisert installert og konfigurert
- **VIKTIG:** Implementert `schemaName: 'payload'` for å isolere Payload-tabeller fra Prisma-tabeller
- Admin-bruker opprettet og verifisert
- Media upload testet (Johannes_Ada-400x300.jpg)
- GraphQL playground verifisert fungerende

**Teknisk gjeld / Oppfølging:**
- Vurder å legge til email adapter for produksjon (advarsel i console)
- SSL mode warning kan fikses med `sslmode=verify-full` i DATABASE_URL

### File List
| File | Status | Description |
|------|--------|-------------|
| `src/collections/Users.ts` | Modified | Extended with displayName, role fields and RBAC access control |
| `src/collections/Media.ts` | Modified | Extended with caption, imageSizes, mimeTypes, adminThumbnail |
| `src/payload.config.ts` | Modified | Added `schemaName: 'payload'` for dual-ORM isolation |
| `src/payload-types.ts` | Modified | Regenerated with new User and Media types |
| `src/migrations/index.ts` | Modified | Cleared migrations (schema pushed via dev mode) |
| `README.md` | Modified | Added dual-ORM architecture documentation |
| `media/` | Created | Upload directory for Payload media (gitignored) |

---

## QA Results

### Review Date: 2026-01-22

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: GOOD** - Solid implementation med utmerket dokumentasjon for læringsformål.

**Styrker:**
- Excellent dual-ORM strategy med `schemaName: 'payload'` for tabellisolering
- Comprehensive code comments forklarer "hvorfor" (følger NFR1)
- `saveToJWT: true` på role-feltet gir god ytelse
- WCAG-compliant media med required alt-text
- README har klar arkitektur-dokumentasjon

**Kode-detaljer:**
- `Users.ts`: Well-structured RBAC med admin/editor roller
- `Media.ts`: Proper image sizes (thumbnail, card, full) og MIME-type filtering
- `payload.config.ts`: Minimal og ren konfigurasjon med god schema-isolering

### Refactoring Performed

Ingen refactoring utført - koden er allerede av god kvalitet.

### Compliance Check

- Coding Standards: ✅ TypeScript strict, well-commented, proper types
- Project Structure: ✅ Files in correct locations (src/collections/)
- Testing Strategy: ✅ Manual verification appropriate for CMS setup story
- All ACs Met: ✅ All 8 acceptance criteria verified and passing

### Improvements Checklist

[x] Dual-ORM dokumentasjon er utmerket
[x] Access control er korrekt implementert
[x] TypeScript types er regenerert og korrekte
[x] WCAG-compliance for media (required alt)
[ ] **Minor:** Vurder å legge til `adminThumbnail: ({ doc }) => doc.url` for bedre admin UX (lav prioritet)
[ ] **Future:** Email adapter for produksjon (dokumentert i Dev Notes)
[ ] **Future:** SSL mode i DATABASE_URL for produksjon

### Security Review

**Status: PASS**

- Access control korrekt implementert på begge collections
- Role-based permissions (admin/editor) fungerer som forventet
- Public read for media er intensjonelt og dokumentert
- `saveToJWT: true` eliminerer unødvendige DB-oppslag
- Ingen sensitive data eksponert

### Performance Considerations

**Status: PASS**

- `saveToJWT: true` gir rask tilgangskontroll uten DB-oppslag
- Image sizes er pre-konfigurert for responsive bilder
- Schema-isolering (`schemaName: 'payload'`) forhindrer ORM-konflikter

### Files Modified During Review

Ingen filer modifisert.

### Gate Status

**Gate: PASS** → docs/qa/gates/1.3-payload-cms-integration.yml

### Recommended Status

**✅ Ready for Done** - Alle acceptance criteria er oppfylt, koden er av god kvalitet, og dokumentasjonen er utmerket. Story kan merkes som Done.
